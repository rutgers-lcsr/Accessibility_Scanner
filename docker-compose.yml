services:
    a11y-nginx:
        container_name: a11y_nginx
        image: nginx:latest
        ports:
            - '443:443'
        volumes:
            - ./certs:/etc/nginx/certs:ro
            - ./nginx.conf:/etc/nginx/nginx.conf
        depends_on:
            - a11y-nextjs
        restart: unless-stopped
        logging:
            driver: json-file
            options:
                max-size: '10m'
                max-file: '3'
    a11y-nextjs:
        container_name: a11y_nextjs
        build:
            context: ./accessibility-front
            dockerfile: ./Dockerfile
        env_file:
            - .env
        environment:
            - API_URL=http://a11y-api:5000
            - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            - NEXT_PUBLIC_BASE_URL=${CLIENT_URL}
            - NEXT_PUBLIC_CAS_URL=${NEXT_PUBLIC_CAS_URL}
            - NEXT_CAS_CLIENT_SAML_TOLERANCE=180000
            - NEXT_CAS_CLIENT_SECRET=${NEXT_CAS_CLIENT_SECRET}
        depends_on:
            - a11y-db
        restart: unless-stopped
        logging:
            driver: json-file
            options:
                max-size: '10m'
                max-file: '3'
    a11y-scanner:
        container_name: a11y_scanner
        build:
            context: .
            dockerfile: Dockerfile.scanner
        env_file:
            - .env
        environment:
            - FLASK_ENV=${FLASK_ENV}
            - DATABASE_URL=mariadb+mariadbconnector://ally-user:${DB_PASSWORD}@a11y-db:3306/a11y
            - API_URL=http://a11y-api:5000
            - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            - CLIENT_URL=${CLIENT_URL}
        depends_on:
            - a11y-nextjs
        restart: unless-stopped
        logging:
            driver: json-file
            options:
                max-size: '10m'
                max-file: '3'
    a11y-api:
        container_name: a11y_api
        build: .
        env_file:
            - .env
        environment:
            - FLASK_ENV=${FLASK_ENV}
            - DATABASE_URL=mariadb+mariadbconnector://ally-user:${DB_PASSWORD}@a11y-db:3306/a11y
            - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            - HOSTNAME=${HOSTNAME}
            - CLIENT_URL=${CLIENT_URL}
            - MAIL_SERVER=${MAIL_SERVER}
            - MAIL_PORT=${MAIL_PORT}
            - MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER}
            - SITE_ADMINS=${SITE_ADMINS}
            - ADMIN_EMAIL=${ADMIN_EMAIL}
            - ADMIN_PASSWORD=${ADMIN_PASSWORD}
        depends_on:
            - a11y-db
        restart: unless-stopped
        logging:
            driver: json-file
            options:
                max-size: '10m'
                max-file: '3'
    a11y-db:
        container_name: a11y_db
        image: mariadb:latest
        command:
            - --innodb_page_size=64k
            - --innodb_buffer_pool_size=10G
            - --innodb_log_file_size=256M
            - --innodb_log_group_home_dir=/var/log/mysql
        env_file:
            - .env
        environment:
            - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
            - MARIADB_USER=ally-user
            - MARIADB_PASSWORD=${DB_PASSWORD}
            - MARIADB_DATABASE=a11y
        healthcheck:
            test:
                [
                    'CMD',
                    'mariadb-admin',
                    'ping',
                    '-h',
                    'a11y-db',
                    '--silent',
                    '--user=root',
                    '--password=${DB_ROOT_PASSWORD}',
                ]
            interval: 10s
            timeout: 10s
            retries: 5
        restart: unless-stopped
        logging:
            driver: json-file
            options:
                max-size: '10m'
                max-file: '3'
        volumes:
            - a11y_db_data:/var/lib/mysql
            - a11y_db_txlogs:/var/log/mysql
    adminer:
        image: adminer
        environment:
            - ADMINER_DEFAULT_SERVER=a11y-db
        restart: always
        ports:
            - 8080:8080
volumes:
    a11y_db_data:
        driver: local
        driver_opts:
            type: nfs
            o: addr=${NFS_SERVER_IP},rw
            device: :${NFS_SHARE_PATH}/mariadb
    a11y_db_txlogs:
        driver: local
